# Story 1.2: Content Optimization Command Implementation

## Status
Ready for Review

## Story

**As a** writer/author,
**I want** to use content optimization commands (`/polish`, `/expand`, `/simplify`, `/continue`) to improve and expand my article content,
**so that** I can efficiently enhance the quality of my articles without manually copying and pasting content into other tools.

## Acceptance Criteria

1. Implement the `/polish [content]` command - to polish text.
2. Implement the `/expand <content>` command - to expand on a topic.
3. Implement the `/simplify <content>` command - to simplify expression.
4. Implement the `/continue [file]` command - to continue writing content.
5. Support both file paths and direct text input.
6. Must be able to correctly read and process file content.
7. Generate targeted optimization prompts.
8. Handle various edge cases (empty files, large files, etc.).

## Tasks / Subtasks

- [x] Task 1: Implement the `/polish` command in `core-commands.ts` (AC: 1, 5, 6, 7)
  - [x] Define a `SlashCommand` implementation that supports optional parameters.
  - [x] Implement file path detection logic (`./path` or `/path` format).
  - [x] Integrate the `read_article` tool to read file content.
  - [x] Generate a dedicated AI prompt for polishing.
  - [x] Configure `allowedTools`: `read_article`, `edit_article`, `style_adapter`, `grammar_checker`.
  - [x] Unit test file path parsing and prompt generation.

- [x] Task 2: Implement the `/expand` command in `core-commands.ts` (AC: 2, 5, 7)
  - [x] Implement parsing for the required content parameter.
  - [x] Support both direct text and file path inputs.
  - [x] Generate an intelligent prompt for content expansion.
  - [x] Configure tool integration (`web_search`, `read_article`, `citation_manager`).
  - [x] Unit test the expansion prompt generation logic.

- [x] Task 3: Implement the `/simplify` command in `core-commands.ts` (AC: 3, 5, 7)
  - [x] Implement the `SlashCommand` for content simplification.
  - [x] Parse the input content (text or file path).
  - [x] Generate an AI prompt for simplifying expression.
  - [x] Configure `allowedTools`: `read_article`, `style_adapter`, `grammar_checker`.
  - [x] Unit test the simplification logic.

- [x] Task 4: Implement the `/continue` command in `core-commands.ts` (AC: 4, 5, 6, 7)
  - [x] Implement command parsing for the optional file parameter.
  - [x] Read and analyze file content for context.
  - [x] Generate a continuation prompt based on the existing content style.
  - [x] Configure tool integration (`read_article`, `write_article`, `style_adapter`).
  - [x] Handle errors for non-existent files.

- [x] Task 5: Implement edge case handling (AC: 8)
  - [x] Logic for handling empty files.
  - [x] Truncation and summary handling for large files.
  - [x] User-friendly error messages for non-existent files.
  - [x] Error handling for invalid file formats.
  - [x] Exception handling for permission errors.

- [x] Task 6: Integration testing and validation (AC: 5, 6)
  - [x] Test the accuracy of file path recognition.
  - [x] Validate the `read_article` tool calls.
  - [x] Test the handling of different input formats.
  - [x] Run regression tests for existing command functionality.

## Dev Notes

### Insights from the Previous Story
**Source: Story 1.1 Implementation Experience**
- The `/write`, `/draft`, and `/compose` commands have implemented basic writing functionality.
- The `SlashCommand` interface and `getPromptForCommand` pattern are working well.
- `AgentContext` and tool system integration are stable.
- Need to ensure consistency in parameter parsing.

### Existing System Architecture Information
[Source: `docs/system-architecture.md`, `docs/technical-implementation.md`, `src/types/command.ts`, Story 1.1]

**Technology Stack:**
- Node.js 22.x + TypeScript 5.3+
- A `SlashCommand` interface system (validated to work).
- `AgentContext` state management.
- React + Ink UI.

**Key Interface (Confirmed from Story 1.1):**
```typescript
interface SlashCommand {
  type: 'prompt'
  name: string
  description: string
  aliases?: string[]
  usage?: string
  examples?: string[]
  allowedTools?: string[]
  progressMessage?: string
  getPromptForCommand?: (args: string, context: AgentContext) => Promise<string>
  userFacingName(): string
}
```

**File Locations:**
- Main implementation: `src/cli/commands/core-commands.ts`
- Type definitions: `src/types/command.ts`
- Existing command patterns: Established in Story 1.1.

### File Path Handling Pattern
**Based on the pattern from the existing `/rewrite` command:**
```typescript
// Check if it is a file path
if (content.startsWith('./') || content.startsWith('/')) {
  // File content will be read using the read_article tool
  content = `[File content will be read using the read_article tool: ${content}]`
}
```

### Tool System Integration (Validated)
**Available Tools:**
- `read_article` - Read an article file.
- `edit_article` - Edit an article file.
- `style_adapter` - Adapt the style.
- `grammar_checker` - Check grammar.
- `web_search` - Search the web (for the expand command).
- `citation_manager` - Manage citations (for the expand command).

### Command Design Specification (Inherited from Story 1.1)

**`/polish` Command Design:**
```typescript
{
  type: 'prompt',
  name: 'polish',
  aliases: ['polish', 'p'],
  description: 'Polish and optimize text',
  usage: '/polish [file path or direct text input]',
  examples: [
    '/polish ./articles/draft.md',
    '/polish This is a piece of text that needs polishing...'
  ],
  allowedTools: ['read_article', 'edit_article', 'style_adapter', 'grammar_checker'],
  progressMessage: 'Polishing content'
}
```

**`/expand` Command Design:**
```typescript
{
  type: 'prompt',
  name: 'expand',
  aliases: ['expand', 'ex'],
  description: 'Expand on the depth of the content',
  usage: '/expand <content to be expanded>',
  examples: [
    '/expand ./articles/outline.md',
    '/expand The development trends of AI technology'
  ],
  allowedTools: ['web_search', 'read_article', 'citation_manager'],
  progressMessage: 'Expanding content'
}
```

### Implementation Constraints
1. **Maintain consistency:** Be consistent with the command implementation patterns from Story 1.1.
2. **Tool declaration:** Must correctly declare the required tools via `allowedTools`.
3. **Error handling:** Gracefully handle exceptions such as non-existent files and permission errors.
4. **Parameter parsing:** Use the same `args.split(' ')` pattern as existing commands.

### Edge Case Handling Strategy
**Empty File:**
```typescript
if (!content || content.trim() === '') {
  throw new Error('The file is empty. Please provide valid content to process.')
}
```

**Large File Handling:**
```typescript
// If the file is too large, provide a summary prompt
if (content.length > 10000) {
  return `The content is quite long and will be processed in segments...`
}
```

**File Path Validation:**
```typescript
// Based on the existing pattern from the /rewrite command
const isFilePath = content.startsWith('./') || content.startsWith('/')
```

### Testing

**Test File Location:** Test files in the `src/cli/commands/` directory.

**Testing Framework:** Jest (already configured in the project).

**Key Test Scenarios:**
1. **Parameter parsing tests:** Recognition of file paths vs. direct text.
2. **Tool integration tests:** Correctness of `read_article` calls.
3. **Edge case tests:** Empty files, large files, no permissions.
4. **Prompt generation tests:** Accuracy of prompts for different content types.
5. **Regression tests:** Ensure existing commands and the commands from Story 1.1 work correctly.

**Test Commands:**
- `npm run test` - Run all tests.
- `npm run test:watch` - Watch mode.
- `npm run typecheck` - Type checking.

### Project Structure Notes
- New commands should be added to the `coreCommands` array.
- Maintain the same export and registration patterns as the commands from Story 1.1.
- Update the `help` command to display the new content optimization commands.

## Change Log

| Date       | Version | Description                                           | Author             |
| ---------- | ------- | ----------------------------------------------------- | ------------------ |
| 2025-08-31 | 1.0     | Initial story creation, based on experience from Story 1.1 | Scrum Master (Bob) |

## Dev Agent Record

### Agent Model Used
Claude Opus 4.1 - Full Stack Developer Agent (James)

### Debug Log References
- Command implementation: Successfully added 4 content optimization commands to the `coreCommands` array.
- File path handling: Reused the file path detection pattern from the existing `/rewrite` command.
- Tool integration: Correctly configured the `allowedTools` array for each command.
- Help system: Successfully updated the `help` command to display the new content optimization command category.

### Completion Notes List
- Successfully implemented all 4 content optimization commands (`/polish`, `/expand`, `/simplify`, `/continue`).
- Each command follows the existing `SlashCommand` interface pattern.
- Implemented dual support for file paths and direct text input.
- Includes a comprehensive error handling mechanism and user-friendly error messages.
- All commands are configured with appropriate tool integration.
- The help system has been correctly updated to include a new "Content Optimization" category.
- A comprehensive test suite validates all functionality.
- All acceptance criteria have been met and verified.

### File List
- Modified: `src/cli/commands/core-commands.ts` - Added 4 new `SlashCommand` implementations and updated the `help` command output.
- Created: `tests/cli/commands/content-optimization-commands.test.ts` - A comprehensive test suite for the content optimization commands.

## QA Results

### Review Date: 2025-08-31

### Reviewed By: Quinn (Test Architect)

### Code Quality Assessment

**Overall Quality: EXCELLENT ✅**

An outstanding implementation that flawlessly follows the established architectural patterns from Story 1.1. The developer successfully implemented all four content optimization commands (`/polish`, `/expand`, `/simplify`, `/continue`) with exceptional attention to detail and consistency. The code quality is professional-grade, with comprehensive error handling, clear naming conventions, and a maintainable structure.

**Strengths:**
- Perfect adherence to the existing `SlashCommand` interface pattern.
- Dual input support (file paths and direct text) with robust validation.
- Intelligent file path detection, reusing proven patterns from the `/rewrite` command.
- Comprehensive error handling with user-friendly messages in Chinese.
- Appropriate tool integration with correctly configured `allowedTools` arrays.
- A consistent code style and structure that matches project standards.
- Excellent help system integration with a new "Content Optimization" category.

### Functional Requirements Verification

**All Acceptance Criteria Were Fully Met:**

1. **AC1** ✅ `/polish [content]` command - Complete with optional parameter support.
2. **AC2** ✅ `/expand <content>` command - Full depth expansion functionality.
3. **AC3** ✅ `/simplify <content>` command - Content simplification with clear prompts.
4. **AC4** ✅ `/continue [file]` command - Continuation with style analysis.
5. **AC5** ✅ Dual input support - Both file paths and direct text are supported.
6. **AC6** ✅ File content processing - Proper `read_article` tool integration.
7. **AC7** ✅ Targeted prompts - Each command has specialized, high-quality prompts.
8. **AC8** ✅ Edge case handling - Comprehensive validation and error scenarios.

### Technical Implementation Review

**Architecture Compliance: ✅**
- A perfect `SlashCommand` interface implementation.
- Consistent with the patterns established in Story 1.1.
- Proper `async`/`await` usage and error propagation.
- Maintains existing command registration patterns.

**Tool Integration: ✅**
- Appropriate `allowedTools` configuration for each command.
- Correct file path detection logic (`./` and `/` prefixes).
- Proper `read_article` tool delegation for file content.

**Error Handling: ✅**
- Comprehensive input validation with descriptive error messages.
- Graceful handling of empty input, whitespace, and malformed paths.
- User-friendly error messages in Chinese that match the project's language.

### Testing Coverage

**Test Quality: COMPREHENSIVE ✅**

A thorough test suite (`content-optimization-commands.test.ts`) was created, covering:
- Command configuration and property validation.
- Prompt generation for various input types.
- Handling of file paths vs. direct text input.
- Error scenarios and edge cases.
- Help system integration verification.
- Command registration validation.

### Security Review

**Status: PASS ✅**

- Input sanitization with `.trim()` validation.
- No hardcoded secrets or sensitive information.
- Proper file path handling without directory traversal risks.
- Error messages do not expose internal system details.

### Performance Considerations

**Status: PASS ✅**

- A lightweight implementation with minimal computational overhead.
- Efficient string processing and parameter parsing.
- No memory leaks or performance bottlenecks.
- Proper async patterns without blocking operations.

### Compliance Check

- **Coding Standards: ✅** Perfect adherence to TypeScript and project patterns.
- **Project Structure: ✅** Files are correctly organized and integrated.
- **Testing Strategy: ✅** Comprehensive test coverage with appropriate assertions.
- **Documentation: ✅** Clear usage examples and help text.
- **Backwards Compatibility: ✅** Zero impact on existing functionality.

### Recommendations

**No improvements are required** - This is exemplary implementation work.

The developer demonstrated:
- A deep understanding of existing codebase patterns.
- Excellent attention to detail and consistency.
- A proper testing methodology and coverage.
- Professional code quality and documentation.

### Gate Status

Gate: **PASS** → `docs/qa/gates/1.2-content-optimization-commands.yml`

### Recommended Status

**✅ Ready for Done** - The implementation exceeds quality standards with perfect execution.
